<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earth & Moon 3D Simulation</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: sans-serif;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="info">
        <h2>3D 地球與月球運行模擬</h2>
        <p>左鍵拖曳旋轉 | 滾輪縮放 | 右鍵平移</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. 初始化場景 ---
        const scene = new THREE.Scene();

        // --- 2. 設定相機 ---
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 20, 50); // 設置相機初始位置

        // --- 3. 設定渲染器 ---
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- 4. 加入控制器 (滑鼠互動) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 10;
        controls.maxDistance = 200;

        // --- 5. 燈光設定 ---
        // 環境光 (讓背光面不要全黑)
        const ambientLight = new THREE.AmbientLight(0x333333);
        scene.add(ambientLight);

        // 太陽光 (模擬太陽方向光源)
        const sunLight = new THREE.DirectionalLight(0xffffff, 2);
        sunLight.position.set(50, 30, 50);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- 6. 載入紋理 (Texture Loader) ---
        const textureLoader = new THREE.TextureLoader();
        
        // 地球貼圖 (使用網路上公開的資源)
        const earthMap = textureLoader.load('https://upload.wikimedia.org/wikipedia/commons/c/cf/WorldMap-A_non-frame.png');
        const earthBumpMap = textureLoader.load('https://upload.wikimedia.org/wikipedia/commons/c/c3/Earth_bump_map_b%26w.jpg'); // 用於製造凹凸感
        const moonMap = textureLoader.load('https://upload.wikimedia.org/wikipedia/commons/d/db/Moonmap_from_clementine_data.png');

        // --- 7. 建立物件 ---

        // [地球主體]
        const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
        const earthMaterial = new THREE.MeshPhongMaterial({
            map: earthMap,
            bumpMap: earthBumpMap,
            bumpScale: 0.15,
            specular: new THREE.Color('grey'),
            shininess: 10
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        scene.add(earth);

        // [地球大氣層] (稍微大一點的透明球體)
        const cloudGeometry = new THREE.SphereGeometry(5.1, 64, 64);
        const cloudMaterial = new THREE.MeshPhongMaterial({
            color: 0x88ccff,
            transparent: true,
            opacity: 0.15,
            side: THREE.DoubleSide
        });
        const atmosphere = new THREE.Mesh(cloudGeometry, cloudMaterial);
        scene.add(atmosphere);

        // [月球]
        const moonGeometry = new THREE.SphereGeometry(1.3, 32, 32);
        const moonMaterial = new THREE.MeshPhongMaterial({
            map: moonMap
        });
        const moon = new THREE.Mesh(moonGeometry, moonMaterial);
        
        // 我們將月球加入到場景中，之後透過數學計算來移動它
        scene.add(moon);

        // [星空背景]
        const starGeometry = new THREE.BufferGeometry();
        const starCount = 2000;
        const starPositions = new Float32Array(starCount * 3);
        for(let i=0; i<starCount * 3; i++) {
            starPositions[i] = (Math.random() - 0.5) * 600; // 隨機分布在空間中
        }
        starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5, sizeAttenuation: true });
        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);


        // --- 8. 動畫循環 ---
        // 設定公轉參數
        let theta = 0; 
        const orbitRadius = 20; // 月球離地球的距離
        const orbitSpeed = 0.005; // 公轉速度

        function animate() {
            requestAnimationFrame(animate);

            // 地球自轉
            earth.rotation.y += 0.002;
            atmosphere.rotation.y += 0.0025; // 大氣層轉快一點點模擬流動

            // 月球公轉邏輯 (Trigonometry)
            theta += orbitSpeed;
            moon.position.x = orbitRadius * Math.sin(theta);
            moon.position.z = orbitRadius * Math.cos(theta);
            
            // 月球自轉 (月球雖然被潮汐鎖定，但在模擬中給點旋轉視覺上較好，或是設為同步自轉)
            moon.rotation.y += 0.01;

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // --- 9. 視窗縮放處理 ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>